<!-- partials/todays-results.ejs -->
 <% const sortedLotteries = []; %>
<% if (todays && todays.length > 0) { %>
<%
  // First, determine status for each lottery and store with lottery data
  const now = new Date();
  const processedLotteries = todays.map(lottery => {
    let status, badgeClass, showCountdown = false, showRefresh = false;
    
    // Calculate the earliest upcoming resultTime for sorting
    let earliestUpcomingTime = null;
    if (lottery.winners && lottery.winners.length > 0) {
      const upcomingTimes = lottery.winners
        .filter(winner => winner.resultTime)
        .map(winner => new Date(winner.resultTime))
        .filter(time => time > now);
      
      if (upcomingTimes.length > 0) {
        earliestUpcomingTime = new Date(Math.min(...upcomingTimes.map(t => t.getTime())));
      }
    }
    
    showCountdown = !!lottery.nextDrawTime;
    
    // Check all resultTimes in winners array for 1 hour AFTER result time (LIVE status)
    const hasLiveResultTime = lottery.winners && lottery.winners.some(winner => {
      if (winner.resultTime) {
        const resultTime = new Date(winner.resultTime);
        const timeDiff = now - resultTime;
        // LIVE for exactly 1 hour AFTER result time (0 to 1 hour)
        return timeDiff >= 0 && timeDiff <= (60 * 60 * 1000);
      }
      return false;
    });
    
    if (hasLiveResultTime) {
      // Within 1 hour AFTER any result time - LIVE status
      status = "LIVE";
      badgeClass = "live-badge";
      showRefresh = true;
    } else {
      // Check for UPCOMING result times (future result times more than 1 hour away)
      const hasUpcomingResultTime = lottery.winners && lottery.winners.some(winner => {
        if (winner.resultTime) {
          const resultTime = new Date(winner.resultTime);
          const timeDiff = resultTime - now;
          // UPCOMING if more than 1 hour in future
          return timeDiff > (60 * 60 * 1000);
        }
        return false;
      });
      
      if (hasUpcomingResultTime) {
        // Future result time exists but more than 1 hour away - UPCOMING status
        status = "UPCOMING";
        badgeClass = "upcoming-badge";
        showCountdown = true;
        showRefresh = false;
      } else {
        // Check if any past result time exists (more than 1 hour after)
        const hasPastResultTime = lottery.winners && lottery.winners.some(winner => {
          if (winner.resultTime) {
            const resultTime = new Date(winner.resultTime);
            const timeDiff = now - resultTime;
            // PAST if more than 1 hour after result time
            return timeDiff > (60 * 60 * 1000);
          }
          return false;
        });
        
        if (hasPastResultTime) {
          // Past result time exists (more than 1 hour after) - RESULT status
          status = "RESULT";
          badgeClass = "result-badge";
          showRefresh = false;
        } else {
          // No resultTime at all, fallback to drawDate logic
          const drawTime = new Date(lottery.drawDate);
          const hoursAfterDraw = (now - drawTime) / (1000 * 60 * 60);

          if (now < drawTime) {
            status = "UPCOMING";
            badgeClass = "upcoming-badge";
            showCountdown = true;
          } else if (hoursAfterDraw <= 2) {
            status = "LIVE";
            badgeClass = "live-badge";
            showCountdown = false;
            showRefresh = false;
          } else {
            status = "RESULT";
            badgeClass = "result-badge";
            showCountdown = false;
            showRefresh = false;
          }
        }
      }
    }
    
    return {
      ...lottery,
      status,
      badgeClass,
      showCountdown,
      showRefresh,
      earliestUpcomingTime,
      sortPriority: status === "UPCOMING" ? 1 : status === "LIVE" ? 2 : 3
    };
  });
  
  // Sort lotteries: UPCOMING first, then LIVE, then RESULT
  // For UPCOMING: show only the latest (closest to current time)
  // For others: show all
  const upcomingLotteries = processedLotteries.filter(l => l.status === "UPCOMING");
  const liveLotteries = processedLotteries.filter(l => l.status === "LIVE");
  const resultLotteries = processedLotteries.filter(l => l.status === "RESULT");
  
  // Find the latest upcoming lottery (closest to current time)
  let latestUpcomingLottery = null;
  if (upcomingLotteries.length > 0) {
    // Sort upcoming by earliest upcoming time or nextDrawTime
    upcomingLotteries.sort((a, b) => {
      const timeA = a.earliestUpcomingTime || new Date(a.nextDrawTime) || new Date(a.drawDate);
      const timeB = b.earliestUpcomingTime || new Date(b.nextDrawTime) || new Date(b.drawDate);
      return timeA - timeB; // Ascending (earliest first)
    });
    // Take only the first (earliest) upcoming lottery
    latestUpcomingLottery = upcomingLotteries[0];
  }
  
  // Combine sorted lotteries in desired order
  
  if (latestUpcomingLottery) {
    sortedLotteries.push(latestUpcomingLottery);
  }
  sortedLotteries.push(...liveLotteries);
  sortedLotteries.push(...resultLotteries);
%>

<section>
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-xl font-bold section-title flex items-center">
      <i class="fas fa-calendar-day text-blue-500 mr-2 text-xl"></i>
      Today's Results
    </h2>
    <span class="bg-gradient-to-r from-blue-500 to-purple-500 text-white text-sm px-3 py-1 rounded-full font-semibold">
      <%= sortedLotteries.length %> Results
    </span>
  </div>

  <div class="space-y-6">
    <% sortedLotteries.forEach((lottery, index) => { 
      const drawTime = new Date(lottery.nextDrawTime ? lottery.nextDrawTime : lottery.lastDrawTime);
      const formattedDate = drawTime.toLocaleDateString('en-GB', { 
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true,
        timeZone: 'Asia/Dubai' 
      }).replace(',', '');
      
      const firstPrize = lottery.prizes.find(p => p.rank === 1);
    %>

    <!-- Step 3b: Render lottery card -->
    <div class="lottery-card <%= lottery.dayName %>-card cursor-pointer" onclick="toggleResult('today<%= index %>')">
      <div class="flex items-center justify-between">
        <div class="flex-1 card-element-spacing">
          <!-- Status badge -->
          <div class="flex flex-wrap items-center" style="row-gap: 9px; column-gap: 20px;">
            <span class="<%= lottery.badgeClass %> rounded-full"><%= lottery.status %></span>
            <span class="card-text-secondary card-date"><%= formattedDate %></span>
          </div>

          <!-- Lottery name -->
          <h3 class="card-text card-lottery-name"><%= lottery.name %><br><%= lottery.name2 || '' %></h3>

          <!-- Step 3c: Conditional countdown timer -->
          <% if (lottery.showCountdown && lottery.nextDrawTime) { %>
          <div class="countdown-container" data-countdown-id-index="<%= index %>" data-next-draw="<%= lottery.nextDrawTime %>">
            <div class="flex items-center justify-between">
              <span class="countdown-label">Draws in:</span>
              <div class="flex space-x-2 items-center">
                <div class="countdown-badge" id="today-countdown<%= index %>-hours" >00</div>
                <span class="card-text font-bold">:</span>
                <div class="countdown-badge" id="today-countdown<%= index %>-minutes">00</div>
                <span class="card-text font-bold">:</span>
                <div class="countdown-badge" id="today-countdown<%= index %>-seconds">00</div>
              </div>
            </div>
          </div>
          <% } %>

          <!-- priZe listing -->
          <% lottery.prizes.forEach(prize => { %>
          <div class="flex items-center card-text-secondary">
            <i class="fas fa-trophy text-yellow-300 mr-2"></i>
            <span class="card-prize">
              <% 
                let rankStatus = 'th';
                if(prize.rank === 1) rankStatus = 'st';
                else if(prize.rank === 2) rankStatus = 'nd';
                else if(prize.rank === 3) rankStatus = 'rd';
                else rankStatus = 'th';
              %>
              <%= prize.rank %><%= rankStatus %> Prize: Nu. <%= prize.amount.toLocaleString('en-US') %>
            </span><br>
          </div>
          <% }); %>
          
          <!-- Step 3d: Conditional refresh button -->
          <% if(lottery.showRefresh){ %>
          <div class="mt-4 text-center">
            <button onclick="refreshResults('<%= lottery._id %>')" class="refresh-btn" id="refresh-<%= lottery._id %>">
              <i class="fas fa-sync-alt mr-1"></i>
              Refresh Results
            </button>
          </div>
          <% } %>

        </div>
        <div class="text-right ml-4">
          <i id="arrow-today<%= index %>" class="fas fa-chevron-down card-text text-xl transition-transform duration-300"></i>
        </div>
      </div>

      <!-- Step 3e: Expandable results -->
      <div id="today<%= index %>" class="card-expand collapsed mt-6">
        <div class="result-container space-y-4">
          <!-- result card loop -->
          <% 
            const now2 = new Date();
            const sortedWinners = lottery.winners.slice().sort((a, b) => {
              const dateA = new Date(a.resultTime);
              const dateB = new Date(b.resultTime);
              const isUpcomingA = dateA > now2;
              const isUpcomingB = dateB > now2;

              if (isUpcomingA && !isUpcomingB) return -1;
              if (!isUpcomingA && isUpcomingB) return 1;

              if (isUpcomingA && isUpcomingB) {
                return dateA - dateB;
              } else {
                return dateB - dateA;
              }
            });

            sortedWinners.forEach(winner => {
              const resultTime = new Date(winner.resultTime);
              const options = { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true, 
                timeZone: 'Asia/Dubai' 
              };
              const formattedTime = resultTime.toLocaleString('en-IN', options);
              
              const firstTicketNumber = winner.winNumbers[0].ticketNumber;
              const ticketLength = firstTicketNumber.toString().length;
              const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
              const ticketLetters = letters.slice(0, ticketLength);
              
              let allResultPublished = winner.winNumbers.every(winNumber => winNumber.resultStatus === true);
          %>
          
          <div class="result-card">
            <div class="result-card-header">
              <%= formattedTime %>
            </div>
            <div class="result-card-content">
              <div class="letter-container">
                <% ticketLetters.forEach((letter, idx) => { %>
                <div class="letter-box"><%= letter %></div>
                <% }); %>
              </div>

              <% if(allResultPublished){ %>
              <div class="winning-numbers-container">
                <div class="winning-number-item">
                  <div class="winning-number" data-ticket-number="<%= firstTicketNumber %>">
                    <%= firstTicketNumber %>
                  </div>
                </div>
              </div>
              <% }else{ %>
              <div class="winning-numbers-container1" style="margin-top: 14px;">
                <img src="/images/dummy-counter-box.png" style="height: 78px; width: 235px ">
              </div>
              <% } %>

              <div class="otherPrizeContainer">
                <% winner.winNumbers.forEach((winNumberObj, idx) => { 
                  let rankStatus2 = 'th';
                  if(winNumberObj.prizeRank === 1) rankStatus2 = 'st';
                  else if(winNumberObj.prizeRank === 2) rankStatus2 = 'nd';
                  else if(winNumberObj.prizeRank === 3) rankStatus2 = 'rd';
                  else rankStatus2 = 'th';
                %>
                  <% if(idx === 4) { %>
                  <div class="win-items">
                    <span class="prize-Rank">üéñÔ∏è5th Prize : <b>(Single number all series)</b></span>
                  </div>
                  <% }else if(idx < 4){ %>
                    <% if (!winNumberObj.resultStatus) { %>
                    <div class="win-items">
                      <span class="prize-Rank">üéñÔ∏è<%= winNumberObj.prizeRank %><%= rankStatus2 %> Prize :</span>
                      <div class="result-winning-number result-winning-number_if_no_results underline-animated"></div>
                    </div>
                    <% }else{ %>
                    <div class="win-items">
                      <span class="prize-Rank">üéñÔ∏è<%= winNumberObj.prizeRank %><%= rankStatus2 %> Prize :</span>
                      <div class="result-winning-number"><%= winNumberObj.ticketNumber %></div>
                    </div>
                    <% } %>
                  <% } %>
                <% }); %>
              </div>
            </div>
          </div>
          <% }); %>
        </div>
      </div>
    </div>
    <% }); %>
  </div>
</section>
<% } %>