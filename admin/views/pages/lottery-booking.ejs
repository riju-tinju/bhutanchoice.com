<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex">
  <title>Admin - Bhutan State Lotteries</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* ===== CSS Variables ===== */
    :root {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --primary-light: #93c5fd;
      --secondary: #10b981;
      --secondary-dark: #059669;
      --danger: #ef4444;
      --danger-dark: #dc2626;
      --warning: #f59e0b;
      --warning-dark: #d97706;
      --dark: #1e293b;
      --light: #f8fafc;
      --gray: #64748b;
      --gray-light: #e2e8f0;
      --gray-dark: #475569;
      --white: #ffffff;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: all 0.3s ease;
    }

    /* ===== Base Styles ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      padding: 16px;
    }

    /* ===== Main Container ===== */
    .booking-container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      min-height: calc(100vh - 32px);
    }

    /* ===== Header ===== */
    .booking-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      padding: 24px 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .booking-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
      opacity: 0.3;
      animation: float 20s linear infinite;
    }

    @keyframes float {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .page-title {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .page-subtitle {
      font-size: 0.95rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    /* ===== Current Lottery Banner ===== */
    .current-lottery-banner {
      background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
      color: var(--white);
      padding: 20px;
      border-radius: var(--radius);
      margin: 20px;
      box-shadow: var(--shadow);
      animation: fadeIn 0.5s ease;
    }

    .lottery-info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    @media (min-width: 640px) {
      .lottery-info-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .lottery-info-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .lottery-info-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .lottery-info-label {
      font-size: 0.85rem;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .lottery-info-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* ===== Form Sections ===== */
    .form-section {
      padding: 24px 20px;
      background: var(--white);
      border-bottom: 1px solid var(--gray-light);
    }

    .form-section:last-of-type {
      border-bottom: none;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--primary-light);
    }

    .section-title i {
      color: var(--primary);
    }

    /* ===== Customer Info Form ===== */
    .customer-form {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    @media (min-width: 768px) {
      .customer-form {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      font-weight: 600;
      color: var(--dark);
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .form-label i {
      color: var(--primary);
      font-size: 0.9rem;
    }

    .form-input {
      padding: 14px 16px;
      border: 2px solid var(--gray-light);
      border-radius: var(--radius-sm);
      font-size: 16px;
      transition: var(--transition);
      background: var(--light);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: var(--white);
    }

    .form-error {
      color: var(--danger);
      font-size: 0.85rem;
      min-height: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ===== Ticket Input Section ===== */
    .ticket-input-card {
      background: var(--light);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .input-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .input-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--dark);
    }

    .ticket-type-display {
      background: var(--white);
      border: 2px solid var(--primary);
      border-radius: 20px;
      padding: 8px 16px;
      font-weight: 600;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ticket-input-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (min-width: 640px) {
      .ticket-input-grid {
        grid-template-columns: 2fr 1fr;
      }
    }

    .ticket-input-wrapper {
      position: relative;
    }

    .ticket-input {
      width: 100%;
      padding: 16px;
      font-size: 1.8rem;
      font-weight: 600;
      text-align: center;
      border: 2px solid var(--gray-light);
      border-radius: var(--radius-sm);
      background: var(--white);
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
      transition: var(--transition);
    }

    .ticket-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .quantity-controls {
      display: flex;
      align-items: stretch;
      background: var(--white);
      border: 2px solid var(--gray-light);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .quantity-btn {
      width: 50px;
      background: var(--light);
      border: none;
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--dark);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .quantity-btn:hover {
      background: var(--gray-light);
    }

    .quantity-btn:active {
      transform: scale(0.95);
    }

    .quantity-input {
      flex: 1;
      border: none;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      padding: 6 10px;
      background: var(--white);
      min-width: 0;
    }

    .quantity-input:focus {
      outline: none;
    }

    .input-helper {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary);
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      color: var(--gray-dark);
      margin-bottom: 20px;
    }

    .add-ticket-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
      color: var(--white);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .add-ticket-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .add-ticket-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ===== Tickets List ===== */
    .tickets-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .tickets-list::-webkit-scrollbar {
      width: 6px;
    }

    .tickets-list::-webkit-scrollbar-track {
      background: var(--gray-light);
      border-radius: 3px;
    }

    .tickets-list::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    .ticket-card {
      background: var(--white);
      border-radius: var(--radius-sm);
      padding: 16px;
      border: 1px solid var(--gray-light);
      transition: var(--transition);
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .ticket-card:hover {
      border-color: var(--primary-light);
      box-shadow: var(--shadow);
    }

    .ticket-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .ticket-number-display {
      font-family: 'Courier New', monospace;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--dark);
      letter-spacing: 1px;
    }

    .ticket-badges {
      display: flex;
      gap: 8px;
    }

    .ticket-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .type-badge {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
    }

    .quantity-badge {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: var(--white);
    }

    .ticket-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ticket-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--secondary-dark);
    }

    .remove-ticket-btn {
      background: var(--danger);
      color: var(--white);
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .remove-ticket-btn:hover {
      background: var(--danger-dark);
      transform: scale(1.1);
    }

    /* ===== Summary Section ===== */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    @media (min-width: 640px) {
      .summary-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    .summary-item {
      background: var(--light);
      border-radius: var(--radius-sm);
      padding: 16px;
      text-align: center;
    }

    .summary-label {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 8px;
      display: block;
    }

    .summary-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--dark);
    }

    .total-amount {
      background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
      color: var(--white);
    }

    .total-amount .summary-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .total-amount .summary-value {
      font-size: 1.5rem;
    }

    /* ===== Actions ===== */
    .actions-bar {
      display: flex;
      gap: 12px;
      padding: 20px;
      background: var(--light);
      border-top: 1px solid var(--gray-light);
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex: 1;
    }

    @media (min-width: 640px) {
      .btn {
        flex: none;
        min-width: 140px;
      }
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-secondary {
      background: var(--gray);
      color: var(--white);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--gray-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, var(--danger-dark) 100%);
      color: var(--white);
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ===== Toast Notification ===== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .toast {
      background: var(--white);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.3s ease;
      transform: translateX(0);
      border-left: 4px solid var(--primary);
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left-color: var(--secondary);
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    .toast i {
      font-size: 1.2rem;
    }

    .toast.success i {
      color: var(--secondary);
    }

    .toast.error i {
      color: var(--danger);
    }

    .toast.warning i {
      color: var(--warning);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 0.9rem;
      color: var(--gray);
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: var(--transition);
    }

    .toast-close:hover {
      background: var(--gray-light);
    }

    /* ===== Loading States ===== */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--gray-light);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .skeleton {
      background: linear-gradient(90deg, var(--gray-light) 25%, var(--light) 50%, var(--gray-light) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* ===== Empty States ===== */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 1.2rem;
      margin-bottom: 8px;
      color: var(--dark);
    }

    /* ===== Responsive Adjustments ===== */
    @media (max-width: 640px) {
      .booking-header {
        padding: 20px 16px;
      }
      
      .page-title {
        font-size: 1.5rem;
      }
      
      .form-section {
        padding: 20px 16px;
      }
      
      .summary-grid {
        grid-template-columns: 1fr;
      }
      
      .actions-bar {
        flex-direction: column;
      }
      
      .toast-container {
        left: 16px;
        right: 16px;
        top: 16px;
      }
    }

    /* ===== Print Styles ===== */
    @media print {
      body {
        background: none;
        padding: 0;
      }
      
      .booking-container {
        box-shadow: none;
        border-radius: 0;
      }
      
      .actions-bar,
      .add-ticket-btn,
      .remove-ticket-btn {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="booking-container">
    <!-- Header -->
    <header class="booking-header">
      <h1 class="page-title">
        <i class="fas fa-ticket-alt"></i>
        Bhutan State Lotteries - Admin Booking
      </h1>
      <p class="page-subtitle">Quick Ticket Booking System</p>
    </header>

    <!-- Current Lottery Info -->
    <div class="current-lottery-banner" id="currentLotteryBanner">
      <div class="lottery-info-grid">
        <div class="lottery-info-item">
          <span class="lottery-info-label">
            <i class="fas fa-trophy"></i>
            Current Lottery
          </span>
          <span class="lottery-info-value" id="lotteryName">Loading...</span>
        </div>
        <div class="lottery-info-item">
          <span class="lottery-info-label">
            <i class="fas fa-hashtag"></i>
            Draw Number
          </span>
          <span class="lottery-info-value" id="drawNumber">#000</span>
        </div>
        <div class="lottery-info-item">
          <span class="lottery-info-label">
            <i class="fas fa-clock"></i>
            Next Draw Time
          </span>
          <span class="lottery-info-value" id="nextDrawTime">Loading...</span>
        </div>
        <div class="lottery-info-item">
          <span class="lottery-info-label">
            <i class="fas fa-calendar-alt"></i>
            Draw Date
          </span>
          <span class="lottery-info-value" id="drawDate">DD/MM/YYYY</span>
        </div>
      </div>
    </div>

    <!-- Customer Information -->
    <section class="form-section">
      <h2 class="section-title">
        <i class="fas fa-user"></i>
        Customer Information
      </h2>
      <form class="customer-form">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-user-circle"></i>
            Customer Name *
          </label>
          <input type="text" id="customerName" class="form-input" placeholder="Enter full name" required>
          <div class="form-error" id="customerNameError"></div>
        </div>
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-phone"></i>
            Phone Number *
          </label>
          <input type="tel" id="customerPhone" class="form-input" placeholder="Enter phone number" required>
          <div class="form-error" id="customerPhoneError"></div>
        </div>
      </form>
    </section>

    <!-- Ticket Input Section -->
    <section class="form-section">
      <h2 class="section-title">
        <i class="fas fa-plus-circle"></i>
        Add Tickets
      </h2>
      <div class="ticket-input-card">
        <div class="input-header">
          <h3 class="input-title">Enter Ticket Details</h3>
          <div class="ticket-type-display">
            <i class="fas fa-hashtag"></i>
            <span id="detectedTicketType">Type: -</span>
          </div>
        </div>

        <div class="ticket-input-grid">
          <div class="ticket-input-wrapper">
            <input type="text" id="ticketNumberInput" class="ticket-input" 
                   placeholder="Enter ticket number (e.g., 12345, A7)"
                   maxlength="5">
            <div class="form-error" id="ticketNumberError"></div>
          </div>
          
          <div class="quantity-controls">
            <button type="button" class="quantity-btn" id="decreaseQuantity">-</button>
            <input type="number" id="ticketQuantity" class="quantity-input" value="1" min="1" max="99">
            <button type="button" class="quantity-btn" id="increaseQuantity">+</button>
          </div>
        </div>

        <div class="input-helper" id="ticketInputHelper">
          <strong>Format Examples:</strong> 5 digits (12345), 4 digits (1234), 3 digits (123), 2 digits (12), or Letter+Digit (A7)
        </div>

        <button type="button" class="add-ticket-btn" id="addTicketBtn" disabled>
          <i class="fas fa-plus"></i>
          Add to Booking
        </button>
      </div>
    </section>

    <!-- Added Tickets List -->
    <section class="form-section" id="ticketsSection" style="display: none;">
      <h2 class="section-title">
        <i class="fas fa-list"></i>
        Booking Summary
        <span class="ticket-count-badge" id="ticketCountBadge">0 tickets</span>
      </h2>
      
      <div class="tickets-list" id="ticketsList">
        <!-- Tickets will be added here dynamically -->
      </div>

      <!-- Empty State -->
      <div class="empty-state" id="emptyTicketsState">
        <i class="fas fa-ticket-alt"></i>
        <h3>No tickets added yet</h3>
        <p>Start by entering a ticket number above</p>
      </div>
    </section>

    <!-- Summary Section -->
    <section class="form-section" id="summarySection" style="display: none;">
      <div class="summary-grid">
        <div class="summary-item" style="display: none;">
          <span class="summary-label">Total Tickets</span>
          <span class="summary-value" id="totalTickets">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Ticket Types</span>
          <span class="summary-value" id="uniqueTypes">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Total Quantity</span>
          <span class="summary-value" id="totalQuantity">0</span>
        </div>
        <div class="summary-item total-amount">
          <span class="summary-label">Total Amount</span>
          <span class="summary-value" id="totalAmount">Nu 0.00</span>
        </div>
      </div>
    </section>

    <!-- Actions Bar -->
    <div class="actions-bar" id="actionsBar" style="display: none;">
      <button type="button" class="btn btn-secondary" id="clearAllBtn">
        <i class="fas fa-trash"></i>
        Clear All
      </button>
      <button type="button" class="btn btn-danger" id="cancelBookingBtn">
        <i class="fas fa-times"></i>
        Cancel
      </button>
      <button type="button" class="btn btn-primary" id="confirmBookingBtn">
        <i class="fas fa-check"></i>
        Confirm Booking
      </button>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-spinner"></div>
  </div>

  <script>
    (function() {
      'use strict';

      // State Management
      const state = {
        currentLottery: null,
        ticketCharges: {},
        addedTickets: [],
        customerInfo: {
          name: '',
          phone: ''
        }
      };

      // DOM Elements
      const elements = {
        // Lottery Info
        lotteryBanner: document.getElementById('currentLotteryBanner'),
        lotteryName: document.getElementById('lotteryName'),
        drawNumber: document.getElementById('drawNumber'),
        drawDate: document.getElementById('drawDate'),
        nextDrawTime: document.getElementById('nextDrawTime'),

        // Customer Info
        customerName: document.getElementById('customerName'),
        customerPhone: document.getElementById('customerPhone'),
        customerNameError: document.getElementById('customerNameError'),
        customerPhoneError: document.getElementById('customerPhoneError'),

        // Ticket Input
        ticketNumberInput: document.getElementById('ticketNumberInput'),
        ticketQuantity: document.getElementById('ticketQuantity'),
        decreaseQuantity: document.getElementById('decreaseQuantity'),
        increaseQuantity: document.getElementById('increaseQuantity'),
        detectedTicketType: document.getElementById('detectedTicketType'),
        ticketNumberError: document.getElementById('ticketNumberError'),
        ticketInputHelper: document.getElementById('ticketInputHelper'),
        addTicketBtn: document.getElementById('addTicketBtn'),

        // Tickets List
        ticketsSection: document.getElementById('ticketsSection'),
        ticketsList: document.getElementById('ticketsList'),
        emptyTicketsState: document.getElementById('emptyTicketsState'),
        ticketCountBadge: document.getElementById('ticketCountBadge'),

        // Summary
        summarySection: document.getElementById('summarySection'),
        totalTickets: document.getElementById('totalTickets'),
        uniqueTypes: document.getElementById('uniqueTypes'),
        totalQuantity: document.getElementById('totalQuantity'),
        totalAmount: document.getElementById('totalAmount'),

        // Actions
        actionsBar: document.getElementById('actionsBar'),
        clearAllBtn: document.getElementById('clearAllBtn'),
        cancelBookingBtn: document.getElementById('cancelBookingBtn'),
        confirmBookingBtn: document.getElementById('confirmBookingBtn'),

        // Overlays
        loadingOverlay: document.getElementById('loadingOverlay'),
        toastContainer: document.getElementById('toastContainer')
      };

      // Initialize
      document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
      });

      async function initializeApp() {
        showLoading(true);
        
        try {
          await Promise.all([
            loadActiveLottery(),
            setupEventListeners()
          ]);

          // Focus on customer name input
          elements.customerName.focus();

          showToast('Booking system ready', 'success');
        } catch (error) {
          console.error('Initialization error:', error);
          showToast('Failed to initialize booking system', 'error');
        } finally {
          showLoading(false);
        }
      }

      function setupEventListeners() {
        // Customer info validation
        elements.customerName.addEventListener('input', validateCustomerInfo);
        elements.customerPhone.addEventListener('input', validateCustomerInfo);

        // Ticket number input
        elements.ticketNumberInput.addEventListener('input', handleTicketNumberInput);
        elements.ticketNumberInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter' && !elements.addTicketBtn.disabled) {
            addTicketToBooking();
          }
        });

        // Quantity controls
        elements.decreaseQuantity.addEventListener('click', () => {
          const current = parseInt(elements.ticketQuantity.value) || 1;
          if (current > 1) {
            elements.ticketQuantity.value = current - 1;
            updateAddButtonText();
          }
        });

        elements.increaseQuantity.addEventListener('click', () => {
          const current = parseInt(elements.ticketQuantity.value) || 1;
          if (current < 99) {
            elements.ticketQuantity.value = current + 1;
            updateAddButtonText();
          }
        });

        elements.ticketQuantity.addEventListener('input', function() {
          let value = parseInt(this.value) || 1;
          if (value < 1) value = 1;
          if (value > 99) value = 99;
          this.value = value;
          updateAddButtonText();
        });

        // Add ticket button
        elements.addTicketBtn.addEventListener('click', addTicketToBooking);

        // Action buttons
        elements.clearAllBtn.addEventListener('click', clearAllTickets);
        elements.cancelBookingBtn.addEventListener('click', cancelBooking);
        elements.confirmBookingBtn.addEventListener('click', confirmBooking);
      }

      // ===== API Functions =====
      async function loadActiveLottery() {
        try {
          const response = await fetch('/api/active-lotteries');
          if (!response.ok) throw new Error('Failed to load lottery data');

          const data = await response.json();
          
          if (!data.success || !data.currentLottery) {
            throw new Error(data.message || 'No active lottery found');
          }

          state.currentLottery = data.currentLottery;
          state.ticketCharges = data.ticketCharges || {};

          updateLotteryDisplay();
          showToast('Lottery loaded successfully', 'success');

        } catch (error) {
          console.error('Error loading active lottery:', error);
          
          // Show error state
          elements.lotteryBanner.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
          elements.lotteryName.textContent = 'No Active Lottery';
          elements.drawNumber.textContent = '#000';
          elements.drawDate.textContent = '--/--/----';
          elements.nextDrawTime.textContent = 'Not Available';
          
          showToast('No active lottery available for booking', 'warning');
          disableTicketInput();
        }
      }

      // ===== Ticket Type Detection =====
      function detectTicketType(ticketNumber) {
        const num = ticketNumber.trim().toUpperCase();
        
        // Type 1: One letter (A-E) followed by one digit
        if (/^[A-E][0-9]$/.test(num)) {
          return { type: 1, valid: true, example: 'A7' };
        }
        // Type 2: Exactly 2 digits
        else if (/^\d{2}$/.test(num)) {
          return { type: 2, valid: true, example: '12' };
        }
        // Type 3: Exactly 3 digits
        else if (/^\d{3}$/.test(num)) {
          return { type: 3, valid: true, example: '123' };
        }
        // Type 4: Exactly 4 digits
        else if (/^\d{4}$/.test(num)) {
          return { type: 4, valid: true, example: '1234' };
        }
        // Type 5: Exactly 5 digits
        else if (/^\d{5}$/.test(num)) {
          return { type: 5, valid: true, example: '12345' };
        }
        // Invalid format
        else {
          return { type: null, valid: false, example: '' };
        }
      }

      function calculateTicketPrice(ticketType) {
        return state.ticketCharges[ticketType] || 0;
      }

      // ===== Ticket Input Handling =====
      function handleTicketNumberInput() {
        const ticketNumber = elements.ticketNumberInput.value.trim().toUpperCase();
        elements.ticketNumberInput.value = ticketNumber;

        if (!ticketNumber) {
          resetTicketDisplay();
          return;
        }

        const detection = detectTicketType(ticketNumber);
        
        if (detection.valid) {
          const price = calculateTicketPrice(detection.type);
          
          elements.detectedTicketType.textContent = `Type ${detection.type} (Nu ${price})`;
          elements.ticketNumberError.textContent = '';
          elements.addTicketBtn.disabled = false;
          
          // Update helper text
          elements.ticketInputHelper.innerHTML = `
            <strong>Ticket Type ${detection.type}:</strong> 
            ${detection.example} format detected. Price: <strong>Nu ${price}</strong>
          `;
        } else {
          elements.detectedTicketType.textContent = 'Invalid Format';
          elements.ticketNumberError.textContent = 'Invalid ticket number format';
          elements.addTicketBtn.disabled = true;
          
          elements.ticketInputHelper.innerHTML = `
            <strong>Invalid Format:</strong> 
            Must be 5 digits (12345), 4 digits (1234), 3 digits (123), 2 digits (12), or Letter+Digit (A7)
          `;
        }

        updateAddButtonText();
      }

      function resetTicketDisplay() {
        elements.detectedTicketType.textContent = 'Type: -';
        elements.ticketNumberError.textContent = '';
        elements.addTicketBtn.disabled = true;
        elements.ticketInputHelper.innerHTML = `
          <strong>Format Examples:</strong> 5 digits (12345), 4 digits (1234), 3 digits (123), 2 digits (12), or Letter+Digit (A7)
        `;
        updateAddButtonText();
      }

      function updateAddButtonText() {
        const quantity = parseInt(elements.ticketQuantity.value) || 1;
        const ticketNumber = elements.ticketNumberInput.value.trim();
        
        if (!ticketNumber) {
          elements.addTicketBtn.innerHTML = `<i class="fas fa-plus"></i> Add to Booking`;
          return;
        }

        const detection = detectTicketType(ticketNumber);
        if (!detection.valid) return;

        const price = calculateTicketPrice(detection.type);
        const totalPrice = price * quantity;

        if (quantity > 1) {
          elements.addTicketBtn.innerHTML = `
            <i class="fas fa-plus"></i>
            Add ${quantity} Tickets (Nu ${totalPrice})
          `;
        } else {
          elements.addTicketBtn.innerHTML = `
            <i class="fas fa-plus"></i>
            Add Ticket (Nu ${price})
          `;
        }
      }

      // ===== Ticket Management =====
      async function addTicketToBooking() {
        const ticketNumber = elements.ticketNumberInput.value.trim().toUpperCase();
        const quantity = parseInt(elements.ticketQuantity.value) || 1;

        // Validation
        if (!ticketNumber) {
          showToast('Please enter a ticket number', 'warning');
          elements.ticketNumberInput.focus();
          return;
        }

        const detection = detectTicketType(ticketNumber);
        if (!detection.valid) {
          showToast('Invalid ticket number format', 'error');
          return;
        }

        if (!state.currentLottery) {
          showToast('No active lottery available', 'error');
          return;
        }

        // Check for duplicate in current session
        const isDuplicate = state.addedTickets.some(ticket => 
          ticket.number === ticketNumber && 
          ticket.type === detection.type
        );

        if (isDuplicate) {
          showToast('This ticket number is already in your booking', 'warning');
          return;
        }

        // Optional: Check with backend for existing tickets
        try {
          showLoading(true);
          
          const checkResponse = await fetch('/api/booking/check-ticket', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ticketNumber,
              lotteryId: state.currentLottery.parentId,
              drawTimeId: state.currentLottery.drawTimeId,
              ticketType: detection.type
            })
          });

          const checkData = await checkResponse.json();
          
          if (checkData.exists) {
            showToast('This ticket number already exists in the system', 'error');
            return;
          }
        } catch (error) {
          console.warn('Could not check ticket existence:', error);
          // Continue anyway - backend will validate again
        } finally {
          showLoading(false);
        }

        // Add ticket(s) to state
        const price = calculateTicketPrice(detection.type);
        
        for (let i = 0; i < quantity; i++) {
          const ticket = {
            id: `ticket_${Date.now()}_${Math.random().toString(36).substr(2, 9)}_${i}`,
            number: ticketNumber,
            type: detection.type,
            price: price,
            quantity: 1,
            lottery: {
              id: state.currentLottery.parentId,
              name: state.currentLottery.name,
              drawNumber: state.currentLottery.drawNumber,
              drawTime: state.currentLottery.drawTime,
              drawTimeId: state.currentLottery.drawTimeId
            },
            addedAt: new Date()
          };

          state.addedTickets.push(ticket);
        }

        // Update UI
        updateTicketsList();
        updateSummary();
        showTicketsSection();

        // Reset input for next ticket
        elements.ticketNumberInput.value = '';
        elements.ticketQuantity.value = '1';
        resetTicketDisplay();
        
        // Show success message
        if (quantity > 1) {
          showToast(`Added ${quantity} tickets with number ${ticketNumber}`, 'success');
        } else {
          showToast(`Added ticket ${ticketNumber}`, 'success');
        }

        // Focus back on ticket input
        setTimeout(() => {
          elements.ticketNumberInput.focus();
        }, 100);
      }

      function removeTicket(ticketId) {
        state.addedTickets = state.addedTickets.filter(ticket => ticket.id !== ticketId);
        
        updateTicketsList();
        updateSummary();
        
        if (state.addedTickets.length === 0) {
          hideTicketsSection();
        }
        
        showToast('Ticket removed from booking', 'info');
      }

      function clearAllTickets() {
        if (state.addedTickets.length === 0) return;
        
        if (!confirm('Remove all tickets from the booking?')) return;
        
        state.addedTickets = [];
        updateTicketsList();
        updateSummary();
        hideTicketsSection();
        
        showToast('All tickets removed', 'info');
      }

      // ===== UI Updates =====
      function updateLotteryDisplay() {
        if (!state.currentLottery) return;

        const lottery = state.currentLottery;
        
        elements.lotteryName.textContent = lottery.name;
        elements.drawNumber.textContent = `#${lottery.drawNumber}`;
        // elements.drawDate.textContent = lottery.drawDate
        // 1. Convert the ISO string into a Date object
const drawDateObject = new Date(lottery.drawDate);

// 2. Use the Date object's toLocaleString method for formatting
elements.drawDate.textContent = drawDateObject.toLocaleDateString('en-IN', {
  day: '2-digit',
  month: 'long',
  year: 'numeric',
  timeZone: 'Asia/Dubai'
});
// .toLocaleString('en-IN', {
//     hour: 'numeric',
//     minute: '2-digit',
//     hour12: true,
//     timeZone: 'Asia/Dubai'
// });
        const drawTimeObject = new Date(lottery.nextDrawTime);
        elements.nextDrawTime.textContent = drawTimeObject.toLocaleString('en-IN', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true,
          timeZone: 'Asia/Dubai'
        });

        // Update banner color based on draw status
        if (lottery.isNext && lottery.timeUntilDraw > 0) {
          // Upcoming draw
          const hoursUntil = Math.floor(lottery.timeUntilDraw / (1000 * 60 * 60));
          const minutesUntil = Math.floor((lottery.timeUntilDraw % (1000 * 60 * 60)) / (1000 * 60));
          
          if (hoursUntil < 1) {
            elements.lotteryBanner.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
          }
        } else if (!lottery.isNext) {
          // Past draw
          elements.lotteryBanner.style.background = 'linear-gradient(135deg, #64748b 0%, #475569 100%)';
        }
      }

      function updateTicketsList() {
        // Group tickets by number and type
        const groupedTickets = {};
        
        state.addedTickets.forEach(ticket => {
          const key = `${ticket.number}_${ticket.type}`;
          if (!groupedTickets[key]) {
            groupedTickets[key] = {
              number: ticket.number,
              type: ticket.type,
              price: ticket.price,
              count: 0,
              tickets: []
            };
          }
          groupedTickets[key].count++;
          groupedTickets[key].tickets.push(ticket);
        });

        // Update ticket count badge
        elements.ticketCountBadge.textContent = `${state.addedTickets.length} ticket${state.addedTickets.length !== 1 ? 's' : ''}`;

        // Clear current list
        elements.ticketsList.innerHTML = '';

        // Add grouped tickets
        Object.values(groupedTickets).forEach(group => {
          const totalPrice = group.price * group.count;
          
          const ticketCard = document.createElement('div');
          ticketCard.className = 'ticket-card';
          ticketCard.innerHTML = `
            <div class="ticket-header">
              <div class="ticket-number-display">${group.number}</div>
              <div class="ticket-badges">
                ${group.count > 1 ? `<span class="ticket-badge quantity-badge">Ã—${group.count}</span>` : ''}
                <span class="ticket-badge type-badge">Type ${group.type}</span>
              </div>
            </div>
            <div class="ticket-details">
              <div class="ticket-price">Nu ${totalPrice.toFixed(2)}</div>
              <button class="remove-ticket-btn" onclick="app.removeTicket('${group.tickets[0].id}')">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          
          elements.ticketsList.appendChild(ticketCard);
        });

        // Show/hide empty state
        elements.emptyTicketsState.style.display = state.addedTickets.length === 0 ? 'block' : 'none';
      }

      function updateSummary() {
        const totalTickets = state.addedTickets.length;
        const uniqueTypes = new Set(state.addedTickets.map(t => t.type)).size;
        const totalQuantity = totalTickets; // Since each ticket has quantity 1 in our current structure
        const totalAmount = state.addedTickets.reduce((sum, ticket) => sum + ticket.price, 0);

        elements.totalTickets.textContent = totalTickets;
        elements.uniqueTypes.textContent = uniqueTypes;
        elements.totalQuantity.textContent = totalQuantity;
        elements.totalAmount.textContent = `Nu ${totalAmount.toFixed(2)}`;
      }

      function showTicketsSection() {
        elements.ticketsSection.style.display = 'block';
        elements.summarySection.style.display = 'block';
        elements.actionsBar.style.display = 'flex';
      }

      function hideTicketsSection() {
        elements.ticketsSection.style.display = 'none';
        elements.summarySection.style.display = 'none';
        elements.actionsBar.style.display = 'none';
      }

      function disableTicketInput() {
        elements.ticketNumberInput.disabled = true;
        elements.ticketQuantity.disabled = true;
        elements.addTicketBtn.disabled = true;
        elements.ticketInputHelper.innerHTML = `
          <strong>Booking Disabled:</strong> 
          No active lottery available for booking
        `;
      }

      // ===== Customer Info Validation =====
      function validateCustomerInfo() {
        const name = elements.customerName.value.trim();
        const phone = elements.customerPhone.value.trim();
        let isValid = true;

        // Clear errors
        elements.customerNameError.textContent = '';
        elements.customerPhoneError.textContent = '';

        // Validate name
        if (!name) {
          elements.customerNameError.textContent = 'Customer name is required';
          isValid = false;
        } else if (name.length < 2) {
          elements.customerNameError.textContent = 'Name must be at least 2 characters';
          isValid = false;
        }

        // Validate phone
        if (!phone) {
          elements.customerPhoneError.textContent = 'Phone number is required';
          isValid = false;
        } else if (!/^\+?[\d\s-()]{8,}$/.test(phone)) {
          elements.customerPhoneError.textContent = 'Enter a valid phone number';
          isValid = false;
        }

        return isValid;
      }

      // ===== Booking Functions =====
      function cancelBooking() {
        if (!confirm('Cancel this booking? All tickets will be removed.')) return;
        
        clearAllTickets();
        resetForm();
        
        showToast('Booking cancelled', 'info');
      }

      async function confirmBooking() {
        // Validate customer info
        if (!validateCustomerInfo()) {
          showToast('Please fix customer information errors', 'error');
          elements.customerName.focus();
          return;
        }

        if (state.addedTickets.length === 0) {
          showToast('Please add at least one ticket', 'error');
          return;
        }

        if (!state.currentLottery) {
          showToast('No active lottery available', 'error');
          return;
        }

        // Confirm booking
        if (!confirm(`Confirm booking of ${state.addedTickets.length} ticket(s) for Nu ${calculateTotalAmount().toFixed(2)}?`)) {
          return;
        }

        try {
          showLoading(true);

          // Group tickets by number and type for backend
          const groupedTickets = {};
          state.addedTickets.forEach(ticket => {
            const key = `${ticket.number}_${ticket.type}`;
            if (!groupedTickets[key]) {
              groupedTickets[key] = {
                lottery: {
                  id: ticket.lottery.id,
                  name: ticket.lottery.name,
                  drawNumber: ticket.lottery.drawNumber,
                  drawDate: state.currentLottery.drawDate,
                  timeId: ticket.lottery.drawTimeId
                },
                number: ticket.number,
                type: ticket.type,
                quantity: 0
              };
            }
            groupedTickets[key].quantity++;
          });

          const bookingData = {
            customer: {
              name: elements.customerName.value.trim(),
              phone: elements.customerPhone.value.trim()
            },
            tickets: Object.values(groupedTickets),
            paymentMethod: 'cash'
          };

          const response = await fetch('bookings/api/bookings', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              // Add authentication token if needed
              // 'Authorization': `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify(bookingData)
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || 'Booking failed');
          }

          if (!result.success) {
            throw new Error(result.message || 'Booking failed');
          }

          // Success
          showToast('Booking confirmed successfully!', 'success');
          
          // Reset form
          setTimeout(() => {
            resetForm();
            showToast('Ready for next booking', 'info');
          }, 2000);

        } catch (error) {
          console.error('Booking error:', error);
          showToast(`Booking failed: ${error.message}`, 'error');
        } finally {
          showLoading(false);
        }
      }

      function resetForm() {
        // Clear customer info
        elements.customerName.value = '';
        elements.customerPhone.value = '';
        elements.customerNameError.textContent = '';
        elements.customerPhoneError.textContent = '';

        // Clear tickets
        state.addedTickets = [];
        updateTicketsList();
        updateSummary();
        hideTicketsSection();

        // Reset ticket input
        elements.ticketNumberInput.value = '';
        elements.ticketQuantity.value = '1';
        resetTicketDisplay();

        // Focus on customer name
        elements.customerName.focus();
      }

      function calculateTotalAmount() {
        return state.addedTickets.reduce((sum, ticket) => sum + ticket.price, 0);
      }

      // ===== Utility Functions =====
      function showLoading(show) {
        elements.loadingOverlay.style.display = show ? 'flex' : 'none';
      }

      function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
          success: 'fas fa-check-circle',
          error: 'fas fa-exclamation-circle',
          warning: 'fas fa-exclamation-triangle',
          info: 'fas fa-info-circle'
        };

        toast.innerHTML = `
          <i class="${icons[type] || icons.info}"></i>
          <div class="toast-content">
            <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
            <div class="toast-message">${message}</div>
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
          </button>
        `;

        elements.toastContainer.appendChild(toast);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 5000);
      }

      // ===== Expose functions to global scope for onclick handlers =====
      window.app = {
        removeTicket,
        showToast,
        showLoading
      };

      // Initialize on load
      initializeApp();

    })();
  </script>
</body>
</html>