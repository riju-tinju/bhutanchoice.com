<script>
  // Step 5a: Countdown management
  function updateCountdowns() {
    // PRIORITY 1: Use sortedTodays if available
    <% if (sortedTodays) { %>
    <% sortedTodays.forEach((lottery, index) => { %>
      <% if (lottery.showCountdown && lottery.nextDrawTime) { %>
        // This matches the order in todays-results.ejs
        updateSingleCountdown('today-countdown<%= index %>', '<%= lottery.nextDrawTime %>');
      <% } %>
    <% }); %>
    <% } else if (todays) { %>
    // FALLBACK: Use original todays array (for backward compatibility)
    <% todays.forEach((lottery, index) => { %>
      <% if (lottery.showCountdown && lottery.nextDrawTime) { %>
        updateSingleCountdown('today-countdown<%= index %>', '<%= lottery.nextDrawTime %>');
      <% } %>
    <% }); %>
    <% } %>

    // Upcoming lotteries remain unchanged
    <% if (upcoming) { %>
    <% upcoming.forEach((lottery, index) => { %>
    updateSingleCountdown('upcoming-countdown<%= index %>', '<%= lottery.drawDate %>');
    <% }); %>
    <% } %>
  }
    

  function updateSingleCountdown(prefix, targetDateStr) {
    const now = new Date().getTime();
    const targetDate = new Date(targetDateStr).getTime();
    const distance = targetDate - now;

    if (distance > 0) {
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      const hoursEl = document.getElementById(prefix + '-hours');
      const minutesEl = document.getElementById(prefix + '-minutes');
      const secondsEl = document.getElementById(prefix + '-seconds');

      if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
      if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
      if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');
    } else {
      // Countdown expired
      const hoursEl = document.getElementById(prefix + '-hours');
      const minutesEl = document.getElementById(prefix + '-minutes');
      const secondsEl = document.getElementById(prefix + '-seconds');
      
      if (hoursEl) hoursEl.textContent = '00';
      if (minutesEl) minutesEl.textContent = '00';
      if (secondsEl) secondsEl.textContent = '00';
    }
  }

  // Step 5b: Refresh results function
  async function refreshResults(lotteryId) {
    const button = document.getElementById(`refresh-${lotteryId}`);
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Refreshing...';

    try {
      const response = await fetch('/api/refresh-results', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          lotteryId
        })
      });

      const result = await response.json();

      if (result.success) {
        window.location.reload();
      } else {
        throw new Error(result.message || 'Failed to refresh');
      }
    } catch (error) {
      console.error('Refresh failed:', error);
      button.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Try Again';
      button.disabled = false;
    }
  }

  // Step 5c: Initialize
  setInterval(updateCountdowns, 1000);
  updateCountdowns(); // Initial call
</script>